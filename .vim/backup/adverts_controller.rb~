class AdvertsController < ApplicationController

  skip_before_filter :authenticate_user!, only: [:index, :show]

  def index
    @q = @adverts.search(params[:q])
    @adverts = @q.result(distinct: true)
    @adverts = @adverts.order().includes(:images).page(params[:page])
  end

  def show
  end

  def new
  end

  def edit
  end

  def create
    authorize! :create, Advert
    @advert = current_user.adverts.new(params[:advert])
    if @advert.save
      redirect_to(@advert, notice: 'Advert was successfully created.')
    else
      render :new
    end
  end

  def update
    if @advert.update_attributes(params[:advert])
      redirect_to(@advert, notice: 'Advert was successfully updated.')
    else
      render :edit
    end
  end

  def destroy
    @advert.destroy
    redirect_to(adverts_url)
  end

  private

  Advert.state_machines[:status].events.map(&:name).each do |status|
    define_method("to_#{status}") do
      @advert.send(status)
      render :show
    end
  end

  def advert_params
    params.require(:advert).permit(:title, :content, :category, images_attributes: [:picture, :id, :_destroy])
  end
end
